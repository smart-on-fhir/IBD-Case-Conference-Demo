<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IBD Case Conference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/boxplot.js"></script>
    <script src="./data.js"></script>
    <script src="./lib.js"></script>
    <style>
        body {
          padding: 2rem;
        }

        img.chart-screenshot {
            width:100%;
            mix-blend-mode: multiply;
            margin-right: 2rem;
            min-width: 500px;
            height: 22em;
        }

        .hc-container {
            /* width: 180px; */
            margin: -4px auto 0;
            display: block;
        }
        .hc-container-small {
            border-left: 1px dashed var(--bs-border-color);
            border-right: 1px dashed var(--bs-border-color);
        }
        th, td {
            vertical-align: middle;
            text-align    : center;
            line-height   : normal;
        }
        .table-hover tbody tr.no-hover:hover > td,
        .table-hover tbody tr.no-hover:hover > th,
        .table-hover td.no-hover,
        .table-hover th.no-hover {
            background-color: inherit;
            box-shadow: none;
            border-color: transparent !important;
        }
        tr.no-border {
            border-color: transparent !important;
        }
        .bg-pale-blue {
            background-color: rgba(var(--bs-success-rgb), 0.05) !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1><i class="bi bi-boxes me-3 text-success"></i>IBD Case Conference</h1>
        <hr />
        <a href="./index.html"><i class="bi bi-arrow-left-circle me-2"></i>Back to list</a>
        <div class="d-flex mb-3 gap-3 mt-4" id="patient-header"></div>
        <div id="patient-description" class="pb-3"></div>


        <div class="table-responsive">
            <table class="table table-hover w-100 mb-0">
                <thead>
                    <tr>
                        <td class="text-start text-success" style="width:auto"><b>IBD Patient Characteristic</b></td>
                        <td style="width:250px"><span class="text-success">IBD Surgery<br/><b>required</b></span><br/><small class="text-muted">(Bowel Resection)</small></td>
                        <td style="width:20px" class="no-hover"></td>
                        <td style="width:250px"><span class="text-success">Anti-TNF<br/><b>responder</b></span><br/><small class="text-muted">(Never Failed)</small></td>
                        <td style="width:250px"><span class="text-success">Anti-TNF<br/><b>non-responder</b></span><br/><small class="text-muted">(Ever Failed)</small></td>
                    </tr>
                </thead>
                <tbody id="data-table-body"></tbody>
                <tbody>
                    <tr class="no-hover no-border">
                        <td colspan="5">&nbsp;</td>
                    </tr>
                    <tr class="no-hover no-border">
                        <td colspan="2" style="vertical-align: middle;">
                            <a><img class="chart-screenshot" /></a>
                        </td>
                        <td class="no-hover"></td>
                        <td colspan="2" style="vertical-align: top; padding: 0;">
                            <table class="table table-sm small w-100 table-hover mt-3">
                                <thead>
                                    <tr>
                                        <th class="text-start pb-2 text-success">IBD Drug Class</th>
                                        <th class="text-center pb-2 text-success" style="width:7em"># Patients</th>
                                        <th class="text-start pb-2 text-success" colspan="2" style="width: 160px;">Surgery free survival years</th>
                                    </tr>
                                </thead>
                                <tbody id="population-table-body"></tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Population table -->
        <!-- <div class="table-responsive mb-5">
            <table class="w-100 table-bordered">
                <tbody>
                    <tr>
                        <td style="vertical-align: middle;">
                            <a><img class="chart-screenshot" /></a>
                        </td>
                        <td style="vertical-align: top; width: 500px">
                            <table class="table table-sm small w-100 table-hover mt-1">
                                <thead>
                                    <tr>
                                        <th class="text-start">IBD Drug Class</th>
                                        <th class="text-center" style="width:7em"># Patients</th>
                                        <th class="text-start" colspan="2" style="width: 160px;">Surgery free survival years</th>
                                    </tr>
                                </thead>
                                <tbody id="population-table-body"></tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div> -->

        <br />
        <div class="bg-light rounded-bottom px-2 py-4 border-top small text-secondary text-center">
            This demo app uses sample data to visualize IBD patient scenarios and is intended for demonstration purposes only.
        </div>
    </div>

    <script>
        jQuery(function ($) {
            const query   = new URL(location.href).searchParams;
            const mrn     = query.get("patient")
            const patient = mrn ? patients.find(p => p.mrn === mrn) : {}

            renderPatientHeader(patient);
            renderPopulationHeader(patient.population);

            const $tbody = $("#data-table-body");
            patient.populationData.forEach((item, index) => {
                const { label, surgery, responder, nonResponder } = item
                $tbody.append(`
                    <tr>
                        <td class="text-start">${label}</td>
                        <td>${surgery.boxplot ? `<a href="${surgery.boxplot.link || "javascript:void 0"}" data-boxplot="${surgery.boxplot.data.join(",")}" data-value="${patient.value}" class="hc-container"></a>` : surgery}</td>
                        <td class="no-hover"></td>
                        <td class="bg-pale-blue">${responder.boxplot ? `<a href="${responder.boxplot.link || "javascript:void 0"}" data-boxplot="${responder.boxplot.data.join(",")}" data-value="${patient.value}" class="hc-container"></a>` : responder}</td>
                        <td class="bg-pale-blue">${nonResponder.boxplot ? `<a href="${nonResponder.boxplot.link || "javascript:void 0"}" data-boxplot="${nonResponder.boxplot.data.join(",")}" data-value="${patient.value}" class="hc-container"></a>` : nonResponder}</td>
                    </tr>
                `);
            });

            $("[data-boxplot]").each((i, node) => {
                const data  = node.getAttribute("data-boxplot").split(",").map(parseFloat)
                const value = node.getAttribute("data-value")
                if (value) {
                    plotChart(node, { data, height: 40, width: 200 }, +value)
                } else {
                    populationPlotChart(node, { data, height: 36, width: 160 })
                }
            })
        })
    </script>
</body>
</html>
