<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IBD Case Conference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/boxplot.js"></script>
    <script src="./data.js"></script>
    <script src="./lib.js"></script>
    <style>
        body {
          padding: 2rem;
          font-size: 110%;
        }
        .hc-container {
            width: 200px;
            /* height: 70px; */
            margin: -6px auto 0;
        }
        th, td {
            vertical-align: middle;
            text-align: center;
        }
        table td:first-child {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="bi bi-boxes me-3 text-success"></i>IBD Case Conference</h1>
        <hr />
        <a href="./index.html"><i class="bi bi-arrow-left-circle me-2"></i>Back to list</a>
        <div class="d-flex mb-3 gap-3 mt-4" id="patient-header"></div>
        <div id="patient-description" class="pb-3"></div>
        <div class="table-responsive">
            <table class="table table-hover w-100">
                <thead class="table-light">
                    <tr>
                        <th class="text-success">Patient Characteristic</th>
                        <th class="text-success">Anti-TNF Responders</th>
                        <th class="text-success">Non-Responders</th>
                    </tr>
                </thead>
                <tbody id="data-table-body"></tbody>
            </table>
        </div>
        <br />
        <hr />
        <p class="small text-secondary text-center">
            This demo app uses sample data to visualize IBD patient scenarios and is intended for demonstration purposes only.
        </p>
    </div>

    <script>
      function plotChart(container, options, patient) {
          Highcharts.chart(container, {
              chart: {
                  type: 'boxplot',
                  inverted: true,
                  backgroundColor: 'transparent',
                  spacing: [0, 2, 4, 2],
                  style: {
                    overflow: 'visible' // prevent SVG clipping
                  },
                  height: 54
              },
              title: null,
              xAxis: {
                  visible: false
              },
              yAxis: {
                  visible   : false,
                  maxPadding: 0,
                  minPadding: 0,
                  min       : options.data[0],
                  max       : options.data[4],

              },
              series: [
                  {
                      type: 'boxplot',
                      data: [options.data],
                      color: options.color,
                      fillColor: options.color + '11',
                      animation: false
                  },
                  {
                      name: 'Patient',
                      type: 'scatter',
                      data: [[0, patient.value]],
                      marker: {
                          enabled: false // hide the dot
                      },
                      animation: false,
                      dataLabels: {
                          enabled: true,
                          useHTML: true,
                          formatter: function () {
                              return `<div style="margin-top:2px;line-height:28px">
                                <span style="color:red;font-size: 23px;vertical-align: top">ðŸ”º</span> ${patient.value}
                                </div>`;
                          },
                          align        : 'left',
                          verticalAlign: 'bottom',
                          y            : 0
                      },
                      enableMouseTracking: false
                  }
              ],
              credits: { enabled: false },
              legend: { enabled: false },
              tooltip: {
                shared: true,
                useHTML: true,
                outside: true,
                animation: false,
                hideDelay: 0,
                style: {
                    fontSize: '16px',
                    fontFamily: 'inherit',
                    color: 'inherit'
                },
                formatter: function () {
                    const bp = options.data;
                    return `
                        <b>Distribution:</b><br/>
                        Min: ${bp[0]}<br/>
                        Q1: ${bp[1]}<br/>
                        Median: ${bp[2]}<br/>
                        Q3: ${bp[3]}<br/>
                        Max: ${bp[4]}<br/>
                        <hr style="margin:4px 0;">
                        <b>Patient value:</b> ${patient.value}`;
                  }
              },
          });
      }
      
      function renderPatientHeader(patient) {
          $('#patient-header').html(`
              <div class="text-success" style="font-size:60px;line-height:1.2">
                  <i class="bi bi-person-circle"></i>
              </div>
              <div>
                  <div class="fw-bold fs-4">${patient.name}</div>
                  <div class="text-success">${buildPatientDemographics(patient)}</div>
              </div>
          `);
          $('#patient-description').html(`<p class="small text-muted mt-2">Cras tincidunt orci lectus, vitae euismod urna fermentum ut. Donec auctor condimentum urna, sed pharetra leo. Vestibulum blandit risus ut pellentesque ullamcorper. Morbi sit amet eros interdum, congue nibh in, semper velit. Donec vitae arcu id nisl pulvinar porta nec eget libero. Sed in nibh ut mauris interdum bibendum. In bibendum ultricies lorem. Integer viverra turpis ut libero egestas, non posuere augue tristique. In nec justo sapien. Vestibulum dignissim, felis vel eleifend ornare, ante lacus rhoncus velit, malesuada scelerisque mauris neque congue dolor. Aenean ultricies eu massa ut aliquam. Sed suscipit nunc sem. Vivamus nec blandit mauris, at facilisis justo. Maecenas faucibus ac velit id vestibulum. Proin venenatis blandit aliquet.</p>`);
      }

        jQuery(function ($) {
            const query = new URL(location.href).searchParams;
            const mrn = query.get("patient")
            const patient = patients.find(p => p.mrn === mrn)

          renderPatientHeader(patient);

          const $tbody = $("#data-table-body");

          patient.populationData.forEach((item, index) => {
              const isBoxplot = Array.isArray(item.responder);
              const row = $(`
                  <tr>
                      <td>${item.label}</td>
                      <td>${isBoxplot ? `<div id="chart-r-${index}" class="hc-container"></div>` : item.responder}</td>
                      <td>${isBoxplot ? `<div id="chart-nr-${index}" class="hc-container"></div>` : item.nonResponder}</td>
                  </tr>
              `);
              $tbody.append(row);

              if (isBoxplot) {
                  plotChart(`chart-r-${index}`, { data: item.responder, color: "#198754" }, patient);
                  plotChart(`chart-nr-${index}`, { data: item.nonResponder, color: "#0d6efd" }, patient);
              }
          });
      })
    </script>
</body>
</html>
